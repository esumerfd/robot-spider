# ESP32-CAM Debugging Session - November 22, 2025

## Problem Statement

ESP32-CAM crashes during servo movement with corrupted serial output. Symptoms:
- Serial output corruption: `Gait 'ArcTest'    ���fgcScScS`
- Repeated restarts (setup runs again)
- Pattern `cScS` appears consistently in corrupted output
- Heap memory remains stable (~330KB free) - not a heap leak

## Debugging Approach

Systematic binary search by commenting out code sections to isolate the crash source.

## Key Findings

### What Works
1. **Basic logging and flasher** - No crash
2. **Body::begin()** - PWM initialization works
3. **Servo::begin()** - Calling `pwm.setPWM()` 12 times in setup works
4. **Body::applyGait()** - Setting servo targets works
5. **Body::update()** without servo movement - Position calculations work
6. **Single `pwm.setPWM()` call in loop** - Works fine
7. **10 calls with 50ms delay** - Works (with occasional serial corruption)

### What Crashes
1. **`pwm.setPWM()` called rapidly in loop** - Crashes/restarts
2. **No delay or short delay (1ms)** - Crashes

### Critical Discovery

The crash is caused by **rapid repeated I2C calls** to `pwm.setPWM()` in the main loop. The same call works fine:
- During setup (called 12 times in Servo::begin())
- Once in the loop
- Multiple times with 50ms delay between calls

## Two Separate Issues Identified

1. **Serial Corruption** - Intermittent, does NOT cause crash
   - Pattern: `���fgcScScS`
   - May be I2C and Serial interaction
   - System continues running despite corruption

2. **Crash/Restart** - Caused by rapid I2C calls
   - No delay or insufficient delay between `pwm.setPWM()` calls
   - Results in ESP32 restart

## Code Path Traced

```
Robot::loop()
  └─> Body::update(deltaMs)
      └─> Leg::update(deltaMs)  [x6 legs]
          └─> Joint::update(deltaMs)  [x2 per leg: shoulder + knee]
              └─> Servo::move(position)
                  └─> pwm.setPWM()  <-- CRASH HERE when rapid
```

## Current State

File: `libraries/robot/servo.cpp`

```cpp
void Servo::move(uint16_t position) {
  _position = position;

  pwm.setPWM(_servonum, 0, _position);
  delay(50);  // 50ms between calls - no limit
}
```

**Status**: Testing if 50ms delay allows continuous operation.

## Configuration Changes Made

### servo.cpp - PWM Initialization (from Adafruit example)
```cpp
pwm.begin();
pwm.setOscillatorFrequency(27000000);  // Calibrate oscillator
pwm.setPWMFreq(50);  // 50 Hz for servos
delay(10);  // Startup delay
```

### Earlier Fixes (from previous session)
1. **servo.h:13** - Changed `Board _board` to `Board& _board` (reference not copy)
2. **logging.cpp** - Static 256-byte buffer instead of 500-byte stack buffer
3. **robot.cpp** - Added heap monitoring diagnostics

## Hardware Info

- **Board**: ESP32-CAM
- **I2C Pins**: SDA=15, SCL=14
- **PWM Driver**: Adafruit PCA9685 at address 0x40
- **Active Servos**: 4 (LeftFront + LeftMiddle legs, 2 joints each)

## Next Steps

1. **Verify 50ms delay works continuously** - Run for 30+ seconds
2. **Reduce delay to find minimum** - Try 20ms, 10ms, 5ms
3. **Investigate serial corruption** - Separate issue, lower priority
4. **Consider alternative approaches**:
   - Batch servo updates
   - Use ESP32 I2C transaction API differently
   - Check for I2C bus speed configuration

## Files Modified This Session

- `libraries/robot/robot.cpp` - Debug comments in/out
- `libraries/robot/body.cpp` - Debug comments, removed yield()
- `libraries/robot/joint.cpp` - Debug comments
- `libraries/robot/servo.cpp` - PWM init changes, delay testing

## Hypothesis

The ESP32-CAM I2C implementation may have a buffer or timing issue when commands are sent too rapidly. The 50ms delay gives the I2C bus and/or PCA9685 chip time to complete each transaction before the next one starts.

The serial corruption may be caused by I2C operations interfering with Serial TX, possibly through shared DMA or interrupt resources on ESP32.

## Test Results Summary

| Test | Description | Result |
|------|-------------|--------|
| 1 | Baseline (no body) | PASS |
| 2 | PWM init only | PASS |
| 3 | PWM + servo loop | PASS |
| 4 | Full Body::begin() | PASS |
| 5 | + applyGait in setup | PASS |
| 6 | + body.update() no servo.move | PASS |
| 7 | + servo.move() no pwm.setPWM | PASS |
| 8 | + pwm.setPWM() no delay | CRASH |
| 9 | + 1ms delay | CRASH |
| 10 | Adafruit example pattern | CRASH |
| 11 | Skip I2C, log only | PASS |
| 12 | Single setPWM in loop | PASS |
| 13 | 10 calls, 50ms delay | PASS (serial corruption) |
| 14 | Unlimited, 50ms delay | TESTING |
